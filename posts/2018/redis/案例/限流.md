限流简单来说就是限制流量，控制流量，避免大流量对系统的冲击。  
另外，也可以用于控制用户的行为，例如控制用户的发帖、回复、点赞等行为，严格要求在规定时间内的操作次数。

使用redis也可以进行限流

## 简单的限流
限定用户的某个行为在指定的时间内只能允许发生N次，例如1分钟内只允许最多回复5个帖子。

可以采用zset来实现，利用滑动窗口机制便可简单实现限流。每一个行为作为zset中的一个key，同一个用户同一种行为用一个zset记录。

通过key中的行为数量就能判断是否超过指定的数量了

```javascript
/**
 * userId 用户Id
 * actionKey 行为key
 * period 指定时间 (秒)
 * macCount 最大次数
 **/ 
function isActionAllow(userId, actionKey, period, maxCount) {
  const key = `reply:${userId}:${actionKey}`
  const currTime = Date.now()

  // 获取窗口内的行为数量
  const currCount = redis.zcard(key)
  if (currCount >= maxCount) return false

  const pipe = redis.pipeline()
  // 记录行为
  pipe.zadd(key, currTime, currTime)
  // 移除时间窗口之前的行为记录，剩下的都是时间窗口内的
  pipe.zremrangebyscore(key, 0, currTime - period * 1000)
  
  // 设置zset过期时间，冷用户过期后将数据清除
  // 过期时间设置为窗口时间+1s
  pipe.expire(key, period + 1)

  await pipe.exec()

  return true
}

const canReply = isActionAllow('seed', 'reply', 60000, 5）
if(canReply) {
  reply()
} else {
  throw new Error('reply is not allow')
}
```

通过pipeline可以提高存取效率，通过一次请求就能完成所有操作。

但是，如果时间窗口内的记录很大，占据的空间就会很大，例如要求60s内操作不能超过100w次操作，就不大适合这种限流方式了。
