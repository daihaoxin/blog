为了避免redis宕机或者宿主机器故障导致redis的短暂不可用，redis提供了主从复制的功能。  

有几点需要认识：
1. 主服务器可以有多个从服务器
2. 复制功能不会阻塞主服务器，即使是进行初次同步也不会阻塞主服务器
3. 复制功能也不会阻塞从服务器
4. 从节点也可以有自己的从节点

实现主从复制的方式：
1. 通过slaveof命令
2. 通过配置的方式

例如通过slaveof方式
```bash
redis> slaveof 192.168.33.10 6379
```
取消从节点
```bash
redis> slaveof no one
```

通过配置的方式
```
slaveof ip port
# 从节点值只做读操作
slave-read-only yes
```

需要注意的是，当节点成为从节点时，自身拥有的数据会被全部清空，以主节点为主。

## 主从复制过程
全量复制：
1. 当从节点连接到主节点时，会先进行全量复制。即主节点会采用bgsave的方式生成rdb文件
2. 在全量复制期间主节点产生的数据，主节点会将这批新数据放入缓冲区
3. 主节点发送rdb文件给从节点，之后再发送缓冲区的数据给从节点
4. 从节点删除旧数据，载入rdb文件和主节点传输过来的缓冲区的数据

部分复制：  
在做完全量复制之后，如果由于网络原因，主从节点间的网络断开了，当连接恢复后，如果还是做全量复制的话就很不值得了，全量复制在数据量很大时很耗性能和网络带宽。

这时候只需要做部分复制即可。

redis在底层提供了数据偏移量，主从节点都会维护一个偏移量，用于记录当前复制的状态。通过该偏移量主节点能够知道该从节点复制到哪份数据，这样只需传输最新的数据给从节点即可。

但如果从节点的偏移量和主节点差别太大超过某个限制值，主节点会采用全量复制的方式进行同步。
